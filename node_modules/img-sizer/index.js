const {join, extname, dirname, basename} = require('path');
const fs = require('fs');
const gm = require('gm');
const ora = require('ora');
const chalk = require('chalk');

module.exports = (files = [], opts) => {
  files.forEach(file => {
    const filepath = join(process.cwd(), file);
    const formats = opts.formats ? `${opts.formats}`.split(',') : [];
    const sizes = opts.sizes ? `${opts.sizes}`.split(',') : [];
    const quality = opts.quality || 80;

    formats.push(extname(filepath).replace('.', ''));

    try {
      fs.statSync(filepath);
    } catch (e) {
      process.stderr.write(chalk.red(`${file} does not exist`));
      process.exit(1);
    }

    if (sizes.length) {
      for (let format of formats) {
        for (let size of sizes) {
          const destFile = `${dirname(filepath)}/${basename(
            filepath,
            extname(filepath)
          )}-${size}.${format}`;
          const spinner = ora(destFile).start();
          gm(filepath)
            .resize(size)
            .quality(quality)
            .noProfile()
            .write(destFile, err => {
              if (!err) {
                spinner.succeed();
              }
            });
        }
      }
    }
  });
};
