import {statSync, unlinkSync} from 'fs';
import {join} from 'path';
import test from 'ava';
import execa from 'execa';

test.after('cleanup', () => {
  unlinkSync(join(__dirname, 'fixtures/test-600.jpg'));
  unlinkSync(join(__dirname, 'fixtures/test-800.jpg'));
  unlinkSync(join(__dirname, 'fixtures/test-600.webp'));
  unlinkSync(join(__dirname, 'fixtures/test2-600.jpg'));
});

test('resize', async t => {
  await execa(join(__dirname, '../cli.js'), [
    'test/fixtures/test.jpg',
    '--sizes=600,800'
  ]);
  t.notThrows(() => {
    statSync(join(__dirname, 'fixtures/test-600.jpg'));
    statSync(join(__dirname, 'fixtures/test-800.jpg'));
  });
});

test('formats', async t => {
  await execa(join(__dirname, '../cli.js'), [
    'test/fixtures/test.jpg',
    '--sizes=600',
    '--formats=jpg,webp'
  ]);
  t.notThrows(() => {
    statSync(join(__dirname, 'fixtures/test-600.jpg'));
    statSync(join(__dirname, 'fixtures/test-600.webp'));
  });
});

test('multiple images', async t => {
  await execa(join(__dirname, '../cli.js'), [
    'test/fixtures/test.jpg',
    'test/fixtures/test2.jpg',
    '--sizes=600'
  ]);
  t.notThrows(() => {
    statSync(join(__dirname, 'fixtures/test-600.jpg'));
    statSync(join(__dirname, 'fixtures/test2-600.jpg'));
  });
});

test('glob', async t => {
  await execa(join(__dirname, '../cli.js'), ['test/fixtures/*', '--sizes=600']);
  t.notThrows(() => {
    statSync(join(__dirname, 'fixtures/test-600.jpg'));
    statSync(join(__dirname, 'fixtures/test2-600.jpg'));
  });
});
